#!/bin/sh
APPIMAGETOOLURL="https://github.com/AppImage/appimagetool/releases/download/continuous/appimagetool-x86_64.AppImage"


APP_IMAGE="@SLIC3R_APP_KEY@_ubu64.AppImage"

wget ${APPIMAGETOOLURL} -O ../appimagetool.AppImage
chmod +x ../appimagetool.AppImage

if [ -f /.dockerenv ] ; then # Only run if inside of a Docker Container
sed '0,/AI\x02/{s|AI\x02|\x00\x00\x00|}' -i  ../appimagetool.AppImage
fi

sed -i -e 's#/usr#././#g' bin/@SLIC3R_APP_CMD@
mv @SLIC3R_APP_CMD@ AppRun
chmod +x AppRun

cp resources/images/@SLIC3R_APP_KEY@_192px.png @SLIC3R_APP_KEY@.png
for PNG_SIZE in 32 128 192; do
    mkdir -p usr/share/icons/hicolor/${PNG_SIZE}x${PNG_SIZE}/apps
    cp resources/images/@SLIC3R_APP_KEY@_${PNG_SIZE}px.png usr/share/icons/hicolor/${PNG_SIZE}x${PNG_SIZE}/apps/@SLIC3R_APP_KEY@.png
done

cat <<EOF > @SLIC3R_APP_KEY@.desktop
[Desktop Entry]
Name=@SLIC3R_APP_KEY@
GenericName=3D Printing Software
Comment=A cutting-edge, feature-rich slicing software.
Exec=AppRun %U
Icon=@SLIC3R_APP_KEY@
Terminal=false
Type=Application
Categories=Graphics;3DGraphics;Engineering;
MimeType=model/stl;model/3mf;application/vnd.ms-3mfdocument;application/prs.wavefront-obj;application/x-amf;x-scheme-handler/bambustudio;x-scheme-handler/bambustudioopen;
Keywords=3D;Printing;Slicer;slice;3D;printer;convert;gcode;stl;obj;amf;SLA
StartupNotify=false
StartupWMClass=@SLIC3R_APP_CMD@
X-AppImage-Version=@SLIC3R_VERSION@
EOF


if [ -f /.dockerenv ] ; then # Only run if inside of a Docker Container
  ../appimagetool.AppImage --appimage-extract-and-run . $([ ! -z "${container}" ] && echo '--appimage-extract-and-run')
else
  ../appimagetool.AppImage . $([ ! -z "${container}" ] && echo '--appimage-extract-and-run')
fi

mv @SLIC3R_APP_KEY@-x86_64.AppImage ${APP_IMAGE}
chmod +x ${APP_IMAGE}
