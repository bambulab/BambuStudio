#!/bin/bash

export ROOT=$(echo $ROOT | grep . || pwd)
export NCORES=`nproc --all`

while getopts ":ih" opt; do
  case ${opt} in
    i )
        export BUILD_IMAGE="1"
        ;;
    h ) echo "Usage: ./BuildLinuxImage.sh [-i]"
        echo "   -i: Generate Appimage (optional)"
        exit 0
        ;;
  esac
done

echo -n "[9/9] Generating Linux app..."
#{
    # create directory and copy into it
    if [ -d "package" ]
    then
        rm -rf package/*
        rm -rf package/.* 2&>/dev/null
    else
        mkdir package
    fi
    mkdir package/bin

    # copy Resources
    cp -Rf ../resources package/resources
    cp -f src/@SLIC3R_APP_CMD@ package/bin/@SLIC3R_APP_CMD@

    #find webkit library
    WEBKIT_LIBS=(
        webkit2gtk-4.*
        libwebkit2gtk-4.*
        libatomic.so*
        libicudata.so*
        libicui18n.so*
        libicuuc.so*
        libjavascriptcoregtk-4.*
        libjpeg.so*
        libwebp.so*
        libwoff2dec.so*
        libwoff2common.so*
        libharfbuzz-icu.so*
        libhyphen.so*
        libsoup-2.4.so*
        libspnav.so*
    )
    export WEBKIT_LIB=libwebkit2gtk-4.*
    export WEBKIT_PATH=''
    search_paths=(
        /usr/lib
        /usr/lib64
        #/usr/local/lib
        #/lib
        #/lib64
    )
    for path in "${search_paths[@]}"; do
        if [[ -d "$path" ]]; then
            WEBKIT_PATH=$(find "$path" -name "$WEBKIT_LIB" -type f -printf '%h\n' -quit 2>/dev/null)
            if [[ -n "$WEBKIT_PATH" ]]; then
                break
            fi
        fi
    done
    if [[ -n "$WEBKIT_PATH" ]]; then
        echo "Found ${WEBKIT_LIB} directory at: $WEBKIT_PATH"
        mkdir -p package/${WEBKIT_PATH}
        echo "Copy libraries from ${WEBKIT_PATH}/ to package/${WEBKIT_PATH}/"
	for dep in "${WEBKIT_LIBS[@]}"
        do
            cp -aL ${WEBKIT_PATH}/${dep} package/${WEBKIT_PATH}/
        done
	find package/${WEBKIT_PATH}/ -name 'libwebkit*' -type f -exec sed -i -e "s|/usr|./usr|g" '{}' \;
    else
        echo "${WEBKIT_LIB} not found."
    fi
    # remove unneeded po from resources
    ## find package/resources/localization -name "*.po" -type f -delete ## FIXME: DD - do we need this?

    # create bin
cat << EOF >@SLIC3R_APP_CMD@
#!/bin/bash
DIR=\$(readlink -f "\$0" | xargs dirname)
export LD_LIBRARY_PATH="\$DIR/bin:\$DIR/$WEBKIT_PATH"

echo "LD_LIBRARY_PATH is \$LD_LIBRARY_PATH"

# FIXME: BambuStudio segfault workarounds
# 1) BambuStudio will segfault on systems where locale info is not as expected (i.e. Holo-ISO arch-based distro)
export LC_ALL=C

# WORKAROUND: change CWD to appimage root, so webkit would be
#             able to start itself using relative path
cd \$DIR

exec "\$DIR/bin/@SLIC3R_APP_CMD@" "\$@"
EOF

    chmod ug+x @SLIC3R_APP_CMD@
    cp -f @SLIC3R_APP_CMD@ package/@SLIC3R_APP_CMD@
    pushd package
    tar -cvf ../@SLIC3R_APP_KEY@.tar .  &>/dev/null
    popd
#} &> $ROOT/Build.log # Capture all command output
echo "done"

if [[ -n "$BUILD_IMAGE" ]]
then
echo -n "Creating Appimage for distribution..."
#{
    pushd package
    chmod +x ../build_appimage.sh
    ../build_appimage.sh
    popd
    mv package/"@SLIC3R_APP_KEY@_ubu64.AppImage" "@SLIC3R_APP_KEY@_ubu64.AppImage"
#} &> $ROOT/Build.log # Capture all command output
echo "done"
fi
